services:
  mysql:
    image: mysql:${MYSQL_TAG}
    restart: always
    labels:
      - dev.orbstack.domains=mysql-warnly.local
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    ports:
      - "3326:3306"
    volumes:
      - mysql_d:/var/lib/mysql
    healthcheck:
      start_period: 5s
      test: '/usr/bin/mysql --user=${MYSQL_USER} --password=${MYSQL_PASSWORD} --execute "SHOW DATABASES;"'
      interval: 5s
      timeout: 30s
      retries: 55

  clickhouse:
    image: clickhouse/clickhouse-server:${CLICKHOUSE_TAG}
    restart: always
    labels:
      - dev.orbstack.domains=clickhouse-warnly.local
    environment:
      - CLICKHOUSE_USER=${CLICKHOUSE_USER}
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD}
      - CLICKHOUSE_DB=${CLICKHOUSE_DB}
    ports:
      - "8133:8123"
      - "9030:9000"
    volumes:
      - clickhouse_data:/var/lib/clickhouse
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8123/ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  keycloak:
     image: quay.io/keycloak/keycloak:26.3.2
     command: ["start-dev", "--import-realm"]
     profiles: ["keycloak"]
     environment:
       KEYCLOAK_ADMIN: admin
       KEYCLOAK_ADMIN_PASSWORD: admin
       KC_HTTP_PORT: "8090"
       KC_HOSTNAME_STRICT: "false"
       KC_HOSTNAME_STRICT_HTTPS: "false"
       KC_CACHE: "local"
     ports:
       - "8090:8090"
     volumes:
       - ./docker/keycloak/export:/opt/keycloak/data/import
     healthcheck:
       test:
         [
           "CMD",
           "curl",
           "-I",
           "-XGET",
           "http://localhost:8090/auth/realms/master",
         ]
       interval: 30s
       timeout: 30s
       retries: 15

  redpanda:
    image: redpandadata/redpanda:${REDPANDA_TAG:-latest}
    profiles: ["queue"]
    command:
      - redpanda
      - start
      - --kafka-addr internal://0.0.0.0:9092,external://0.0.0.0:19092
      - --advertise-kafka-addr internal://redpanda:9092,external://localhost:19092
      - --pandaproxy-addr internal://0.0.0.0:8082,external://0.0.0.0:18082
      - --advertise-pandaproxy-addr internal://redpanda:8082,external://localhost:18082
      - --schema-registry-addr internal://0.0.0.0:8081,external://0.0.0.0:18081
      - --rpc-addr redpanda:33145
      - --advertise-rpc-addr redpanda:33145
      - --mode dev-container
      - --default-log-level=info
    ports:
      - "19092:19092"
      - "18082:18082"
      - "18081:18081"
    healthcheck:
      test: rpk cluster health
      interval: 5s
      timeout: 10s
      retries: 5
    environment:
      - RPK_ALLOW_MEMORY_OVERPROVISIONING=true

  redpanda-console:
    image: redpandadata/console:${REDPANDA_CONSOLE_TAG:-latest}
    profiles: ["queue"]
    depends_on:
      redpanda:
        condition: service_healthy
    ports:
      - "8888:8080"
    environment:
      KAFKA_BROKERS: redpanda:9092
      KAFKA_SCHEMA_REGISTRY_ENABLED: "true"
      KAFKA_SCHEMA_REGISTRY_URLS: http://redpanda:8081
    labels:
      - dev.orbstack.domains=redpanda-console.local

  warnly:
    labels:
      - dev.orbstack.domains=warnly.local
    build:
      context: .
      dockerfile: Dockerfile.air
    environment:
      - MYSQL_DSN=${MYSQL_DSN}
      - CLICKHOUSE_DSN=${CLICKHOUSE_DSN}
      - SCHEME=${SCHEME}
      - CERT_FILE=${CERT_FILE}
      - CERT_KEY=${CERT_KEY}
      - METRICS_PORT=${METRICS_PORT}
      - METRICS_PATH=${METRICS_PATH}
      - METRICS_ENABLED=${METRICS_ENABLED}
      - ADMIN_EMAIL=${ADMIN_EMAIL}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
      - FORCE_MIGRATE=${FORCE_MIGRATE}
      - REMEMBER_SESSION_DAYS=${REMEMBER_SESSION_DAYS}
      - SESSION_KEY=${SESSION_KEY}
      - SERVER_PORT=${SERVER_PORT}
      - SERVER_HOST=${SERVER_HOST}
      - OIDC_PROVIDER_NAME=${OIDC_PROVIDER_NAME}
      - OIDC_ISSUER_URL=${OIDC_ISSUER_URL}
      - OIDC_CLIENT_ID=${OIDC_CLIENT_ID}
      - OIDC_CLIENT_SECRET=${OIDC_CLIENT_SECRET}
      - OIDC_REDIRECT_ADDRESS=${OIDC_REDIRECT_ADDRESS}
      - OIDC_SCOPES=${OIDC_SCOPES}
      - NOTIFICATION_ENCRYPTION_KEY=${NOTIFICATION_ENCRYPTION_KEY}
      - KAFKA_BROKERS=${KAFKA_BROKERS}
      - KAFKA_NAMESPACE=${KAFKA_NAMESPACE}
      - KAFKA_CLIENT_ID=${KAFKA_CLIENT_ID}
      - KAFKA_PRODUCER_SYNC=${KAFKA_PRODUCER_SYNC}
    depends_on:
      mysql:
        condition: service_healthy
      clickhouse:
        condition: service_healthy
      redpanda:
        condition: service_healthy
    profiles: ["queue"]
    ports:
      - 8080:8080
      - 8048:8081
    volumes:
      - ./:/app

volumes:
  mysql_d:
  clickhouse_data:
